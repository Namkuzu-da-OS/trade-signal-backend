<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trading Signals | Multi-Timeframe Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        @keyframes pulse-dot {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .pulse-dot {
            animation: pulse-dot 2s ease-in-out infinite;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        .signal-STRONG_BUY {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .signal-BUY {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .signal-WATCH {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .signal-HOLD {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .signal-SELL {
            background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
        }

        .signal-STRONG_SELL {
            background: linear-gradient(135deg, #b91c1c 0%, #7f1d1d 100%);
        }

        .timeframe-pill {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .tf-high {
            background-color: rgba(20, 83, 45, 0.4);
            color: #86efac;
            border: 1px solid #14532d;
        }

        .tf-medium {
            background-color: rgba(30, 58, 138, 0.4);
            color: #93c5fd;
            border: 1px solid #1e3a8a;
        }

        .tf-low {
            background-color: #1f2937;
            color: #9ca3af;
            border: 1px solid #374151;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .font-mono-nums {
            font-family: 'JetBrains Mono', monospace;
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
        }

        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-950 text-gray-100 font-sans">

    <!-- Navigation Tabs -->
    <nav class="bg-gray-900 border-b border-gray-800 sticky top-0 z-50 shadow-sm">
        <div class="container mx-auto px-4">
            <div class="flex gap-1">
                <a href="/index.html"
                    class="px-6 py-4 text-sm font-semibold text-gray-400 hover:text-white hover:bg-gray-800 transition">üìä
                    Main Dashboard</a>
                <a href="/signals.html"
                    class="px-6 py-4 text-sm font-semibold bg-gray-800 border-b-2 border-emerald-500 text-white">üéØ Live
                    Signals</a>
                <a href="/settings.html"
                    class="px-6 py-4 text-sm font-semibold text-gray-400 hover:text-white hover:bg-gray-800 transition">‚öôÔ∏è
                    Settings</a>
            </div>
        </div>
    </nav>

    <!-- Header Bar -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex items-center justify-between h-16">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-indigo-600 rounded flex items-center justify-center font-bold text-white">TS
                </div>
                <span class="font-bold text-xl tracking-tight text-white">TradeSignal<span
                        class="text-indigo-400">AI</span></span>
            </div>
            <!-- Navigation -->
            <div class="hidden md:flex items-center gap-6 ml-8">
                <a href="/" class="text-white font-medium hover:text-indigo-400 transition-colors">Dashboard</a>
            </div>
            <div class="flex items-center gap-6 text-sm">
                <div class="hidden md:flex items-center gap-2">
                    <span class="text-slate-400">Market Regime:</span>
                    <span id="marketRegime"
                        class="px-2 py-1 rounded bg-slate-500/10 text-slate-400 font-medium border border-slate-500/20">Loading...</span>
                </div>
                <div class="hidden md:flex items-center gap-2">
                    <span class="text-slate-400">VIX:</span>
                    <span id="vixValue" class="font-mono text-slate-400">--</span>
                </div>
                <div class="hidden md:flex items-center gap-2">
                    <span class="text-slate-400">GEX:</span>
                    <span id="gexValue" class="font-mono text-slate-400">--</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-7xl">

        <!-- Header -->
        <div class="bg-gray-900 rounded-lg shadow-lg border border-gray-800 p-6 mb-6">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-white flex items-center gap-3">
                        üéØ Live Trading Signals
                        <span id="statusIndicator"
                            class="text-sm font-normal px-3 py-1 rounded-full bg-gray-800 text-gray-400">Scanner:
                            Stopped</span>
                    </h1>
                    <p class="text-gray-400 mt-1">Multi-Timeframe Analysis | Auto-Refresh: <span
                            id="refreshTimer">30s</span></p>
                </div>
                <div class="flex gap-3">
                    <button id="manualScanBtn"
                        class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow transition text-sm">‚ö°
                        Manual Scan</button>
                    <button id="startBtn"
                        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow transition text-sm">‚ñ∂
                        Start Auto</button>
                    <button id="stopBtn"
                        class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg shadow transition text-sm">‚èπ
                        Stop</button>
                    <button id="backtestBtn"
                        class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg shadow transition text-sm">üìä
                        Backtest</button>
                    <button id="refreshBtn"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow transition text-sm">üîÑ
                        Refresh</button>
                </div>
            </div>

            <!-- Scanner Status Details -->
            <div id="scannerDetails"
                class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t border-gray-800 hidden">
                <div>
                    <p class="text-xs text-gray-500 uppercase">Scan Interval</p>
                    <p class="text-lg font-semibold text-gray-200" id="scanInterval">-</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 uppercase">Watchlist Symbols</p>
                    <p class="text-lg font-semibold text-gray-200" id="watchlistCount">-</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 uppercase">Last Scan</p>
                    <p class="text-lg font-semibold text-gray-200" id="lastScan">-</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 uppercase">Next Scan In</p>
                    <p class="text-lg font-semibold text-gray-200" id="nextScan">-</p>
                </div>
            </div>

            <!-- Activity Console (Collapsed by default) -->
            <div class="mt-4 pt-4 border-t border-gray-800">
                <button id="consoleToggleBtn"
                    class="flex items-center gap-2 text-xs font-semibold text-gray-400 hover:text-white transition">
                    <span id="consoleToggleIcon">‚ñ∂</span> Show Activity Log
                </button>
                <div id="activityConsole"
                    class="mt-2 bg-gray-950 rounded border border-gray-800 p-3 font-mono text-xs max-h-40 overflow-y-auto hidden">
                    <div id="consoleContent" class="space-y-1">
                        <div class="text-gray-600">Waiting for activity...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Signal Type Tabs -->
        <div class="flex border-b border-gray-800 mb-6">
            <button id="tabIntraday"
                class="px-6 py-3 text-sm font-medium text-indigo-400 border-b-2 border-indigo-500 focus:outline-none transition-colors">
                ‚òÄÔ∏è Intraday (Day Trading)
            </button>
            <button id="tabSwing"
                class="px-6 py-3 text-sm font-medium text-gray-400 hover:text-gray-200 focus:outline-none transition-colors">
                üåä Swing (Multi-Day)
            </button>
        </div>

        <!-- View Controls -->
        <div class="flex justify-between items-center mb-4">
            <div class="flex gap-2">
                <button id="viewTableBtn"
                    class="px-3 py-1.5 text-sm font-medium bg-gray-800 text-white rounded border border-gray-700 hover:bg-gray-700 active">List
                    View</button>
                <button id="viewHeatmapBtn"
                    class="px-3 py-1.5 text-sm font-medium bg-gray-900 text-gray-400 rounded border border-gray-800 hover:bg-gray-800 hover:text-white">Heatmap</button>
            </div>
            <div class="flex gap-2">
                <select id="filterSignal"
                    class="bg-gray-900 border border-gray-700 text-gray-300 text-sm rounded px-3 py-1.5 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                    <option value="ALL">All Signals</option>
                    <option value="BUY">Buys Only</option>
                    <option value="SELL">Sells Only</option>
                    <option value="STRONG">Strong Only</option>
                </select>
            </div>
        </div>

        <!-- Heatmap View (Hidden by default) -->
        <div id="heatmapView" class="hidden grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-6">
            <!-- Populated by JS -->
        </div>

        <!-- Signals Table -->
        <div id="tableView" class="bg-gray-900 rounded-lg shadow-lg border border-gray-800 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-800 text-gray-200">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">
                                Symbol</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">
                                Signal</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">
                                Score</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">
                                Timeframes</th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-gray-400 uppercase tracking-wider">
                                Entry</th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-gray-400 uppercase tracking-wider">
                                Stop</th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-gray-400 uppercase tracking-wider">
                                Target</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">
                                Updated</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">
                                Actions</th>
                        </tr>
                    </thead>
                    <tbody id="signalsTable" class="divide-y divide-gray-800">
                        <tr>
                            <td colspan="9" class="px-6 py-12 text-center text-gray-500">
                                <div class="flex flex-col items-center gap-3">
                                    <svg class="w-16 h-16 text-gray-700" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                                        </path>
                                    </svg>
                                    <p class="text-lg font-medium text-gray-400">No signals yet</p>
                                    <p class="text-sm text-gray-500">Start the scanner to begin analyzing your watchlist
                                    </p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Legend -->
        <div class="mt-6 bg-gray-900 rounded-lg shadow border border-gray-800 p-6">
            <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">Signal Legend</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-green-500"></div>
                    <span class="text-xs text-gray-400">STRONG BUY (85%+)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                    <span class="text-xs text-gray-400">BUY (70%+)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                    <span class="text-xs text-gray-400">WATCH (40%+)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-gray-500"></div>
                    <span class="text-xs text-gray-400">HOLD (<40%)< /span>
                </div>
            </div>
        </div>

    </div>

    <!-- Expanded Details Modal -->
    <div id="detailsModal"
        class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div
            class="bg-gray-900 border border-gray-800 rounded-lg shadow-2xl max-w-2xl w-full m-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-white" id="modalSymbol">-</h2>
                    <button id="modalCloseBtn" class="text-gray-400 hover:text-white transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="modalContent" class="space-y-4">
                    <!-- Content populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Backtest Modal -->
    <div id="backtestModal"
        class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-gray-900 border border-gray-800 rounded-lg shadow-2xl max-w-2xl w-full m-4">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-white">üìä Strategy Backtest</h2>
                    <button id="backtestCloseBtn" class="text-gray-400 hover:text-white transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Backtest Form -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-400 text-sm mb-2">Symbol</label>
                        <input id="backtestSymbol" type="text" value="SPY"
                            class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-white focus:ring-2 focus:ring-purple-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-gray-400 text-sm mb-2">Days to Test</label>
                        <select id="backtestDays"
                            class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 text-white focus:ring-2 focus:ring-purple-500 outline-none">
                            <option value="7">7 Days</option>
                            <option value="14">14 Days</option>
                            <option value="30" selected>30 Days</option>
                            <option value="60">60 Days</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-400 text-sm mb-2">
                            Confidence Threshold: <span id="thresholdValue" class="text-white font-semibold">85%</span>
                        </label>
                        <input id="backtestThreshold" type="range" min="50" max="95" value="85" step="5"
                            class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-purple-600">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>50% (Relaxed)</span>
                            <span>95% (Very Strict)</span>
                        </div>
                    </div>
                    <button id="runBacktestBtn"
                        class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition">
                        Run Backtest
                    </button>
                </div>

                <!-- Results -->
                <div id="backtestResults" class="mt-6 hidden">
                    <div class="border-t border-gray-800 pt-4">
                        <h3 class="text-lg font-semibold text-white mb-4">Results</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gray-800 p-4 rounded">
                                <p class="text-gray-400 text-sm">Total Trades</p>
                                <p class="text-2xl font-bold text-white" id="backtestTotalTrades">-</p>
                            </div>
                            <div class="bg-gray-800 p-4 rounded">
                                <p class="text-gray-400 text-sm">Win Rate</p>
                                <p class="text-2xl font-bold text-emerald-400" id="backtestWinRate">-</p>
                            </div>
                            <div class="bg-gray-800 p-4 rounded">
                                <p class="text-gray-400 text-sm">Total P&L</p>
                                <p class="text-2xl font-bold" id="backtestPnL">-</p>
                            </div>
                            <div class="bg-gray-800 p-4 rounded">
                                <p class="text-gray-400 text-sm">Final Balance</p>
                                <p class="text-2xl font-bold text-blue-400" id="backtestBalance">-</p>
                            </div>
                        </div>
                        <div class="mt-4 grid grid-cols-3 gap-4">
                            <div class="bg-gray-800 p-4 rounded">
                                <p class="text-gray-400 text-sm">Profit Factor</p>
                                <p class="text-xl font-bold text-purple-400" id="backtestProfitFactor">-</p>
                            </div>
                            <div class="bg-gray-800 p-4 rounded">
                                <p class="text-gray-400 text-sm">Avg Win</p>
                                <p class="text-xl font-bold text-green-400" id="backtestAvgWin">-</p>
                            </div>
                            <div class="bg-gray-800 p-4 rounded">
                                <p class="text-gray-400 text-sm">Avg Loss</p>
                                <p class="text-xl font-bold text-red-400" id="backtestAvgLoss">-</p>
                            </div>
                        </div>
                        <div class="mt-4 bg-gray-800 p-4 rounded">
                            <p class="text-gray-400 text-sm mb-2">Win/Loss Breakdown</p>
                            <div class="flex gap-4">
                                <div>
                                    <span class="text-green-400 font-semibold" id="backtestWins">0</span>
                                    <span class="text-gray-500 text-sm"> Wins</span>
                                </div>
                                <div>
                                    <span class="text-red-400 font-semibold" id="backtestLosses">0</span>
                                    <span class="text-gray-500 text-sm"> Losses</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let refreshInterval;
        let countdownInterval;
        let refreshCountdown = 30;
        let currentSignals = []; // Store signals for filtering
        let currentTab = 'INTRADAY'; // 'INTRADAY' or 'SWING'

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkScannerStatus();
            refreshSignals();
            startRefreshCountdown();
            fetchActivityLogs();
            fetchMarketStatus();
            setInterval(fetchActivityLogs, 3000);
            setInterval(fetchMarketStatus, 60000);

            // Event Listeners
            document.getElementById('manualScanBtn').addEventListener('click', manualScan);
            document.getElementById('startBtn').addEventListener('click', startScanner);
            document.getElementById('stopBtn').addEventListener('click', stopScanner);
            document.getElementById('refreshBtn').addEventListener('click', refreshSignals);
            document.getElementById('consoleToggleBtn').addEventListener('click', toggleConsole);
            document.getElementById('modalCloseBtn').addEventListener('click', closeModal);

            // Tab Controls
            document.getElementById('tabIntraday').addEventListener('click', () => switchTab('INTRADAY'));
            document.getElementById('tabSwing').addEventListener('click', () => switchTab('SWING'));

            // Backtest Controls
            document.getElementById('backtestBtn').addEventListener('click', openBacktestModal);
            document.getElementById('backtestCloseBtn').addEventListener('click', closeBacktestModal);
            document.getElementById('runBacktestBtn').addEventListener('click', runBacktest);
            document.getElementById('backtestThreshold').addEventListener('input', (e) => {
                document.getElementById('thresholdValue').textContent = e.target.value + '%';
            });

            // View Controls
            document.getElementById('viewTableBtn').addEventListener('click', () => switchView('table'));
            document.getElementById('viewHeatmapBtn').addEventListener('click', () => switchView('heatmap'));
            document.getElementById('filterSignal').addEventListener('change', renderSignals);

            // Event delegation for dynamically created analyze buttons
            document.addEventListener('click', (e) => {
                if (e.target.closest('.analyze-btn')) {
                    const btn = e.target.closest('.analyze-btn');
                    const symbol = btn.dataset.symbol;
                    analyzeSignal(symbol, btn);
                }
                if (e.target.closest('.details-btn')) {
                    const btn = e.target.closest('.details-btn');
                    const symbol = btn.dataset.symbol;
                    showDetails(symbol);
                }
            });

            // Close modal on outside click
            document.getElementById('detailsModal').addEventListener('click', (e) => {
                if (e.target.id === 'detailsModal') closeModal();
            });
        });

        function switchTab(tab) {
            currentTab = tab;
            const tabIntraday = document.getElementById('tabIntraday');
            const tabSwing = document.getElementById('tabSwing');

            if (tab === 'INTRADAY') {
                tabIntraday.classList.add('text-indigo-400', 'border-indigo-500');
                tabIntraday.classList.remove('text-gray-400', 'border-transparent');
                tabSwing.classList.add('text-gray-400', 'border-transparent');
                tabSwing.classList.remove('text-indigo-400', 'border-indigo-500');
            } else {
                tabSwing.classList.add('text-indigo-400', 'border-indigo-500');
                tabSwing.classList.remove('text-gray-400', 'border-transparent');
                tabIntraday.classList.add('text-gray-400', 'border-transparent');
                tabIntraday.classList.remove('text-indigo-400', 'border-indigo-500');
            }
            renderSignals();
        }

        function switchView(view) {
            const tableBtn = document.getElementById('viewTableBtn');
            const heatmapBtn = document.getElementById('viewHeatmapBtn');
            const tableView = document.getElementById('tableView');
            const heatmapView = document.getElementById('heatmapView');

            if (view === 'table') {
                tableView.classList.remove('hidden');
                heatmapView.classList.add('hidden');
                tableBtn.classList.add('bg-gray-800', 'text-white', 'border-gray-700');
                tableBtn.classList.remove('bg-gray-900', 'text-gray-400', 'border-gray-800');
                heatmapBtn.classList.add('bg-gray-900', 'text-gray-400', 'border-gray-800');
                heatmapBtn.classList.remove('bg-gray-800', 'text-white', 'border-gray-700');
            } else {
                tableView.classList.add('hidden');
                heatmapView.classList.remove('hidden');
                heatmapBtn.classList.add('bg-gray-800', 'text-white', 'border-gray-700');
                heatmapBtn.classList.remove('bg-gray-900', 'text-gray-400', 'border-gray-800');
                tableBtn.classList.add('bg-gray-900', 'text-gray-400', 'border-gray-800');
                tableBtn.classList.remove('bg-gray-800', 'text-white', 'border-gray-700');
            }
        }

        function toggleConsole() {
            const console = document.getElementById('activityConsole');
            const icon = document.getElementById('consoleToggleIcon');
            if (console.classList.contains('hidden')) {
                console.classList.remove('hidden');
                icon.textContent = '‚ñº';
            } else {
                console.classList.add('hidden');
                icon.textContent = '‚ñ∂';
            }
        }

        async function fetchActivityLogs() {
            try {
                const response = await fetch('/api/auto/logs?limit=50');
                const data = await response.json();
                const consoleContent = document.getElementById('consoleContent');

                if (!data.logs || data.logs.length === 0) {
                    consoleContent.innerHTML = '<div class="text-gray-400">No activity yet...</div>';
                    return;
                }

                consoleContent.innerHTML = data.logs.map(log => {
                    const time = new Date(log.timestamp).toLocaleTimeString();
                    let colorClass = 'text-gray-300';
                    let icon = '‚Ä¢';

                    switch (log.type) {
                        case 'success': colorClass = 'text-green-400'; icon = '‚úì'; break;
                        case 'warning': colorClass = 'text-yellow-400'; icon = '‚ö†'; break;
                        case 'error': colorClass = 'text-red-400'; icon = '‚úó'; break;
                        case 'info': default: colorClass = 'text-blue-400'; icon = '‚Ñπ';
                    }

                    return `<div class="${colorClass} flex gap-2"><span class="text-gray-500">[${time}]</span><span>${icon}</span><span>${escapeHtml(log.message)}</span></div>`;
                }).join('');
            } catch (error) {
                console.error('Error fetching logs:', error);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function startRefreshCountdown() {
            clearInterval(countdownInterval);
            refreshCountdown = 30;
            countdownInterval = setInterval(() => {
                refreshCountdown--;
                document.getElementById('refreshTimer').textContent = `${refreshCountdown}s`;
                if (refreshCountdown <= 0) {
                    refreshSignals();
                    refreshCountdown = 30;
                }
            }, 1000);
        }

        async function checkScannerStatus() {
            try {
                const response = await fetch('/api/auto/status');
                const status = await response.json();
                const indicator = document.getElementById('statusIndicator');
                const details = document.getElementById('scannerDetails');

                if (status.isRunning) {
                    indicator.innerHTML = '<span class="pulse-dot">‚óè</span> Scanner: Running';
                    indicator.className = 'text-sm font-normal px-3 py-1 rounded-full bg-green-900/30 text-green-400 border border-green-900/50 flex items-center gap-2';
                    details.classList.remove('hidden');
                    document.getElementById('scanInterval').textContent = `${status.intervalMinutes} min`;
                    document.getElementById('watchlistCount').textContent = status.watchlistCount || 0;
                    document.getElementById('lastScan').textContent = status.lastScanTime ? new Date(status.lastScanTime).toLocaleTimeString() : 'Never';

                    if (status.lastScanTime) {
                        const nextScanTime = new Date(new Date(status.lastScanTime).getTime() + status.intervalMinutes * 60000);
                        const now = new Date();
                        const minutesUntil = Math.max(0, Math.round((nextScanTime - now) / 60000));
                        document.getElementById('nextScan').textContent = `${minutesUntil} min`;
                    }
                } else {
                    indicator.textContent = 'Scanner: Stopped';
                    indicator.className = 'text-sm font-normal px-3 py-1 rounded-full bg-gray-800 text-gray-400 border border-gray-700';
                    details.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error checking status:', error);
            }
        }

        async function refreshSignals() {
            try {
                const response = await fetch('/api/signals/live');
                currentSignals = await response.json();
                renderSignals();
                checkScannerStatus();
            } catch (error) {
                console.error('Error refreshing signals:', error);
            }
        }

        function renderSignals() {
            const filter = document.getElementById('filterSignal').value;
            let signals = currentSignals;

            // Filter by Tab (Intraday vs Swing)
            if (currentTab === 'INTRADAY') {
                signals = signals.filter(s => s.score_15m >= 40 || s.score_1h >= 40);
            } else {
                signals = signals.filter(s => s.score_1d >= 40);
            }

            // Filter by Type
            if (filter !== 'ALL') {
                signals = signals.filter(s => {
                    if (filter === 'BUY') return s.final_signal.includes('BUY');
                    if (filter === 'SELL') return s.final_signal.includes('SELL');
                    if (filter === 'STRONG') return s.final_signal.includes('STRONG');
                    return true;
                });
            }

            // Render Table
            const tbody = document.getElementById('signalsTable');
            if (!signals || signals.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="px-6 py-12 text-center text-gray-500">No signals found matching filter</td></tr>`;
            } else {
                tbody.innerHTML = signals.map(signal => {
                    const signalClass = `signal-${signal.final_signal.replace(' ', '_')}`;
                    const timeAgo = getTimeAgo(signal.last_updated);
                    return `
                        <tr class="hover:bg-gray-800/50 transition border-b border-gray-800 last:border-0 group">
                            <td class="px-4 py-3"><div class="font-bold text-base text-gray-100">${signal.symbol}</div></td>
                            <td class="px-4 py-3"><span class="${signalClass} text-white text-xs px-2 py-1 rounded font-bold uppercase tracking-wide">${signal.final_signal}</span></td>
                            <td class="px-4 py-3 text-center"><div class="font-mono font-bold text-gray-200">${signal.final_score}%</div></td>
                            <td class="px-4 py-3 text-center">
                                <div class="flex justify-center gap-1.5">
                                    ${renderTimeframeDot('15m', signal.signal_15m)}
                                    ${renderTimeframeDot('1H', signal.signal_1h)}
                                    ${renderTimeframeDot('1D', signal.signal_1d)}
                                </div>
                            </td>
                            <td class="px-4 py-3 text-right font-mono text-gray-300">${signal.entry_price ? '$' + signal.entry_price.toFixed(2) : '-'}</td>
                            <td class="px-4 py-3 text-right font-mono text-rose-400">${signal.stop_loss ? '$' + signal.stop_loss.toFixed(2) : '-'}</td>
                            <td class="px-4 py-3 text-right font-mono text-emerald-400">${signal.target_price ? '$' + signal.target_price.toFixed(2) : '-'}</td>
                            <td class="px-4 py-3 text-center text-xs text-gray-600 font-mono">${timeAgo}</td>
                            <td class="px-4 py-3 text-center">
                                <div class="flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button id="analyzeBtn-${signal.symbol}" data-symbol="${signal.symbol}" class="analyze-btn p-1.5 bg-indigo-500/10 hover:bg-indigo-500/30 text-indigo-400 rounded border border-indigo-500/20 transition" title="AI Analysis">ü§ñ</button>
                                    <button data-symbol="${signal.symbol}" class="details-btn p-1.5 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded border border-gray-600 transition" title="Details">‚ÑπÔ∏è</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            // Render Heatmap
            const heatmap = document.getElementById('heatmapView');
            if (!signals || signals.length === 0) {
                heatmap.innerHTML = `<div class="col-span-full text-center text-gray-500 py-12">No signals found</div>`;
            } else {
                heatmap.innerHTML = signals.map(signal => {
                    const signalClass = `signal-${signal.final_signal.replace(' ', '_')}`;
                    return `
                        <div onclick="showDetails('${signal.symbol}')" class="cursor-pointer ${signalClass} p-4 rounded-lg shadow-lg hover:scale-105 transition transform relative overflow-hidden group">
                            <div class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition"></div>
                            <div class="relative z-10">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="font-bold text-white text-xl">${signal.symbol}</span>
                                    <span class="font-mono text-white/90 font-bold">${signal.final_score}%</span>
                                </div>
                                <div class="text-xs text-white/80 font-medium uppercase tracking-wider">${signal.final_signal}</div>
                                <div class="mt-3 flex gap-1 justify-end">
                                    ${renderTimeframeDot('15m', signal.signal_15m)}
                                    ${renderTimeframeDot('1H', signal.signal_1h)}
                                    ${renderTimeframeDot('1D', signal.signal_1d)}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        async function showDetails(symbol) {
            try {
                const response = await fetch(`/api/scan/signals/live/${symbol}`);
                const signal = await response.json();

                document.getElementById('modalSymbol').textContent = `${symbol} - Detailed Breakdown`;
                document.getElementById('modalContent').innerHTML = `
                    <div class="bg-gradient-to-r from-gray-800 to-gray-900 p-4 rounded-lg border border-gray-700">
                        <div class="text-3xl font-bold text-center mb-2 text-white">${signal.final_signal}</div>
                        <div class="text-5xl font-bold text-center text-blue-400">${signal.final_score}%</div>
                        <p class="text-center text-gray-400 mt-2">Aggregated Confidence Score</p>
                        ${signal.session_phase ? `<div class="mt-2 text-center text-xs font-mono text-indigo-300 bg-indigo-900/30 py-1 rounded inline-block px-3">SESSION: ${signal.session_phase}</div>` : ''}
                    </div>
                    ${signal.vwap ? `
                    <div class="grid grid-cols-3 gap-2 mb-4 text-xs font-mono text-center">
                        <div class="bg-gray-800 p-2 rounded border border-gray-700">
                            <span class="text-gray-500 block">VAH</span>
                            <span class="text-gray-300">${signal.vah ? '$' + signal.vah.toFixed(2) : '-'}</span>
                        </div>
                        <div class="bg-gray-800 p-2 rounded border border-gray-700">
                            <span class="text-gray-500 block">VWAP</span>
                            <span class="text-indigo-400">${signal.vwap ? '$' + signal.vwap.toFixed(2) : '-'}</span>
                        </div>
                        <div class="bg-gray-800 p-2 rounded border border-gray-700">
                            <span class="text-gray-500 block">VAL</span>
                            <span class="text-gray-300">${signal.val ? '$' + signal.val.toFixed(2) : '-'}</span>
                        </div>
                    </div>` : ''}
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-blue-900/20 border border-blue-900/30 p-4 rounded-lg text-center">
                            <p class="text-sm text-gray-400 mb-1">Entry Price</p>
                            <p class="text-2xl font-bold text-blue-400">${signal.entry_price ? '$' + signal.entry_price.toFixed(2) : 'N/A'}</p>
                        </div>
                        <div class="bg-red-900/20 border border-red-900/30 p-4 rounded-lg text-center">
                            <p class="text-sm text-gray-400 mb-1">Stop Loss</p>
                            <p class="text-2xl font-bold text-red-400">${signal.stop_loss ? '$' + signal.stop_loss.toFixed(2) : 'N/A'}</p>
                        </div>
                        <div class="bg-green-900/20 border border-green-900/30 p-4 rounded-lg text-center">
                            <p class="text-sm text-gray-400 mb-1">Target</p>
                            <p class="text-2xl font-bold text-green-400">${signal.target_price ? '$' + signal.target_price.toFixed(2) : 'N/A'}</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-300 mb-3">Timeframe Breakdown</h3>
                        <div class="space-y-3">
                            <div class="border-l-4 ${getScoreColor(signal.score_15m)} bg-gray-800 p-4 rounded border-r border-t border-b border-gray-700">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-semibold text-gray-200">15-Minute</span>
                                    <span class="timeframe-pill ${getScorePill(signal.score_15m)}">${signal.score_15m}%</span>
                                </div>
                                <div class="text-sm text-gray-400"><strong class="text-gray-200">${signal.signal_15m}</strong> - ${signal.top_strategy_15m}</div>
                            </div>
                            <div class="border-l-4 ${getScoreColor(signal.score_1h)} bg-gray-800 p-4 rounded border-r border-t border-b border-gray-700">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-semibold text-gray-200">1-Hour</span>
                                    <span class="timeframe-pill ${getScorePill(signal.score_1h)}">${signal.score_1h}%</span>
                                </div>
                                <div class="text-sm text-gray-400"><strong class="text-gray-200">${signal.signal_1h}</strong> - ${signal.top_strategy_1h}</div>
                            </div>
                            <div class="border-l-4 ${getScoreColor(signal.score_1d)} bg-gray-800 p-4 rounded border-r border-t border-b border-gray-700">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-semibold text-gray-200">Daily</span>
                                    <span class="timeframe-pill ${getScorePill(signal.score_1d)}">${signal.score_1d}%</span>
                                </div>
                                <div class="text-sm text-gray-400"><strong class="text-gray-200">${signal.signal_1d}</strong> - ${signal.top_strategy_1d}</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-700">
                        <h3 class="font-semibold text-gray-300 mb-2 flex items-center gap-2">
                            <span class="text-indigo-400">ü§ñ Gemini AI Insight</span>
                            ${signal.ai_analysis ? '' : '<span class="text-xs text-gray-500 font-normal">(Not generated yet)</span>'}
                        </h3>
                        <div class="bg-indigo-900/20 border border-indigo-500/30 p-4 rounded-lg text-sm text-gray-300 leading-relaxed">
                            ${signal.ai_analysis ?
                        `<div>
                                    ${renderAIContent(signal.ai_analysis)}
                                    <button id="regenerateAiBtn" class="mt-3 w-full py-2 bg-indigo-900/50 hover:bg-indigo-800 border border-indigo-500/30 text-indigo-200 text-xs rounded transition flex items-center justify-center gap-2">
                                        <span>‚Üª</span> Refresh Analysis
                                    </button>
                                </div>` :
                        `<button id="generateAiBtn" class="w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded transition">Generate AI Analysis</button>`
                    }
                        </div>
                    </div>
                    <div class="text-sm text-gray-500 text-center pt-4 border-t border-gray-700">
                        Last scanned: ${new Date(signal.scan_timestamp).toLocaleString()}
                    </div>
                `;

                // Attach event listener for AI buttons
                const aiBtn = document.getElementById('generateAiBtn');
                if (aiBtn) {
                    aiBtn.addEventListener('click', (e) => analyzeSignal(symbol, e.target));
                }

                const regenBtn = document.getElementById('regenerateAiBtn');
                if (regenBtn) {
                    regenBtn.addEventListener('click', (e) => analyzeSignal(symbol, e.target.closest('button')));
                }

                document.getElementById('detailsModal').classList.remove('hidden');
                document.getElementById('detailsModal').classList.add('flex');
            } catch (error) {
                console.error('Error loading details:', error);
            }
        }

        function closeModal() {
            document.getElementById('detailsModal').classList.add('hidden');
            document.getElementById('detailsModal').classList.remove('flex');
        }

        function openBacktestModal() {
            document.getElementById('backtestModal').classList.remove('hidden');
            document.getElementById('backtestModal').classList.add('flex');
            document.getElementById('backtestResults').classList.add('hidden');
        }

        function closeBacktestModal() {
            document.getElementById('backtestModal').classList.add('hidden');
            document.getElementById('backtestModal').classList.remove('flex');
        }

        async function runBacktest() {
            const symbol = document.getElementById('backtestSymbol').value.toUpperCase();
            const days = parseInt(document.getElementById('backtestDays').value);
            const threshold = parseInt(document.getElementById('backtestThreshold').value);
            const btn = document.getElementById('runBacktestBtn');

            try {
                btn.disabled = true;
                btn.innerHTML = '<span class="animate-spin inline-block">‚Üª</span> Running...';

                const res = await fetch('/api/backtest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol, days, threshold })
                });

                const data = await res.json();

                if (data.error) throw new Error(data.error);

                // Display results
                document.getElementById('backtestTotalTrades').textContent = data.totalTrades;
                document.getElementById('backtestWinRate').textContent = data.winRate;
                document.getElementById('backtestWins').textContent = data.wins;
                document.getElementById('backtestLosses').textContent = data.losses;
                document.getElementById('backtestBalance').textContent = `$${data.finalBalance}`;
                document.getElementById('backtestProfitFactor').textContent = data.profitFactor;
                document.getElementById('backtestAvgWin').textContent = data.avgWin > 0 ? `$${data.avgWin}` : '-';
                document.getElementById('backtestAvgLoss').textContent = data.avgLoss > 0 ? `$${data.avgLoss}` : '-';

                const pnl = parseFloat(data.totalPnL);
                const pnlElement = document.getElementById('backtestPnL');
                pnlElement.textContent = `$${data.totalPnL}`;
                pnlElement.className = `text-2xl font-bold ${pnl >= 0 ? 'text-emerald-400' : 'text-red-400'}`;

                document.getElementById('backtestResults').classList.remove('hidden');

            } catch (error) {
                console.error('Backtest failed:', error);
                alert('Backtest failed: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Run Backtest';
            }
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const seconds = Math.floor((now - then) / 1000);
            if (seconds < 60) return 'Just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            return `${Math.floor(hours / 24)}d ago`;
        }

        function renderTimeframeDot(label, signal) {
            let color = 'bg-gray-700';
            if (signal && (signal.includes('BUY') || signal === 'BREAKOUT ALERT')) color = 'bg-green-500';
            else if (signal && (signal.includes('SELL') || signal === 'BREAKDOWN')) color = 'bg-red-500';
            return `<div class="flex flex-col items-center gap-1" title="${label}: ${signal}"><div class="w-2 h-2 rounded-full ${color}"></div></div>`;
        }

        async function fetchMarketStatus() {
            try {
                const res = await fetch('/api/scan/market/status');
                const data = await res.json();
                const ticker = document.getElementById('marketTicker');
                if (ticker) {
                    if (data.error) throw new Error(data.error);
                    ticker.innerHTML = Object.entries(data).map(([symbol, quote]) => {
                        const color = quote.change >= 0 ? 'text-green-400' : 'text-red-400';
                        const icon = quote.change >= 0 ? '‚ñ≤' : '‚ñº';
                        return `<div class="flex items-center gap-2 min-w-fit"><span class="font-bold text-gray-300">${symbol}</span><span class="${color}">${quote.price.toFixed(2)}</span><span class="${color} text-xs">(${icon}${Math.abs(quote.change).toFixed(2)}%)</span></div>`;
                    }).join('<div class="w-px h-4 bg-gray-800 mx-4"></div>');
                }
            } catch (e) {
                console.error('Market status error:', e);
            }
        }

        window.analyzeSignal = async (symbol, btnElement) => {
            const btn = btnElement || document.getElementById(`analyzeBtn-${symbol}`);
            if (!btn) return;

            const originalContent = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '<span class="animate-spin inline-block">‚Üª</span>';

                const res = await fetch(`/api/signals/live/${symbol}/analyze`, { method: 'POST' });
                const data = await res.json();

                if (data.error) throw new Error(data.error);

                // Refresh details if modal is open
                if (document.getElementById('detailsModal').classList.contains('flex')) {
                    showDetails(symbol);
                } else {
                    // If called from table, just refresh data in background or alert success
                    // For now, we'll just refresh the table to update the AI icon status if we add one
                    refreshSignals();
                }

            } catch (e) {
                console.error('Analysis failed:', e);
                alert('Failed to generate analysis: ' + e.message);
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        };

        function renderAIContent(text) {
            // Parse structured sections with color coding
            let html = text;

            // Replace **bold** with white text
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong class="text-white font-semibold">$1</strong>');

            // Color code each section
            const sections = [
                {
                    tag: '[RISK]',
                    color: 'text-red-300',
                    bgColor: 'bg-red-900/20',
                    borderColor: 'border-l-red-500',
                    icon: '‚ö†Ô∏è',
                    label: 'Risk Assessment'
                },
                {
                    tag: '[EDGE]',
                    color: 'text-emerald-300',
                    bgColor: 'bg-emerald-900/20',
                    borderColor: 'border-l-emerald-500',
                    icon: '‚úì',
                    label: 'Trade Edge'
                },
                {
                    tag: '[WATCH]',
                    color: 'text-yellow-300',
                    bgColor: 'bg-yellow-900/20',
                    borderColor: 'border-l-yellow-500',
                    icon: 'üëÅ',
                    label: 'Watch For'
                },
                {
                    tag: '[CONTEXT]',
                    color: 'text-blue-300',
                    bgColor: 'bg-blue-900/20',
                    borderColor: 'border-l-blue-500',
                    icon: 'üåê',
                    label: 'Market Context'
                }
            ];

            sections.forEach(section => {
                const regex = new RegExp(`\\[${section.tag.slice(1, -1)}\\]\\s*([^\\[]+)`, 'i');
                html = html.replace(regex, (match, content) => {
                    return `
                        <div class="${section.bgColor} ${section.borderColor} border-l-4 rounded p-3 mb-3">
                            <div class="flex items-start gap-2">
                                <span class="text-lg">${section.icon}</span>
                                <div class="flex-1">
                                    <div class="text-xs font-bold uppercase ${section.color} mb-1">${section.label}</div>
                                    <div class="text-gray-200 text-sm leading-relaxed">${content.trim()}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            });

            // Fallback: if no sections were found, just format as before
            if (!html.includes('border-l-4')) {
                html = html.replace(/\n/g, '<br>');
                html = `<div class="text-gray-300 text-sm leading-relaxed">${html}</div>`;
            }

            return html;
        }

        function getScoreColor(score) {
            if (score >= 70) return 'border-green-500';
            if (score >= 40) return 'border-yellow-500';
            return 'border-gray-600';
        }

        function getScorePill(score) {
            if (score >= 70) return 'tf-high';
            if (score >= 40) return 'tf-medium';
            return 'tf-low';
        }

        function renderTimeframeDot(label, signal) {
            let color = 'bg-gray-700';
            if (signal && (signal.includes('BUY') || signal === 'BREAKOUT ALERT')) color = 'bg-green-500';
            else if (signal && (signal.includes('SELL') || signal === 'BREAKDOWN')) color = 'bg-red-500';

            const safeSignal = signal || 'Neutral';
            return `<div class="flex flex-col items-center gap-1" title="${label}: ${safeSignal}">
                <div class="w-2.5 h-2.5 rounded-full ${color} border border-black/20 shadow-sm"></div>
            </div>`;
        }
        async function manualScan() {
            const btn = document.getElementById('manualScanBtn');
            try {
                btn.disabled = true;
                btn.innerHTML = '<span class="animate-spin inline-block">‚Üª</span> Scanning...';
                const response = await fetch('/api/auto/cycle', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
                const result = await response.json();
                setTimeout(refreshSignals, 1000);
                const consoleContent = document.getElementById('consoleContent');
                const time = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = 'text-green-400';
                logEntry.textContent = `[${time}] ‚úì Manual scan completed successfully`;
                consoleContent.insertBefore(logEntry, consoleContent.firstChild);
            } catch (error) {
                console.error('Error running manual scan:', error);
                alert('Manual scan failed: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '‚ö° Manual Scan';
            }
        }

        async function startScanner() {
            try {
                // Fetch settings first to get preferred interval
                let interval = 15;
                try {
                    const settingsRes = await fetch('/api/settings');
                    if (settingsRes.ok) {
                        const settings = await settingsRes.json();
                        interval = settings.scanner.defaultInterval || 15;
                    }
                } catch (e) {
                    console.warn('Could not fetch settings, using default interval 15');
                }

                const response = await fetch('/api/auto/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ intervalMinutes: interval })
                });
                const result = await response.json();
                alert(result.message);
                checkScannerStatus();
                setTimeout(refreshSignals, 2000);
            } catch (error) {
                console.error('Error starting scanner:', error);
                alert('Failed to start scanner');
            }
        }

        async function stopScanner() {
            try {
                const response = await fetch('/api/auto/stop', { method: 'POST' });
                const result = await response.json();
                alert(result.message);
                checkScannerStatus();
            } catch (error) {
                console.error('Error stopping scanner:', error);
                alert('Failed to stop scanner');
            }
        }

        async function fetchMarketHeader() {
            try {
                // Fetch SPY data to get general market state
                const response = await fetch('/api/scan?symbol=SPY&interval=1d');
                const data = await response.json();

                if (data.marketState) {
                    const state = data.marketState;

                    // Update VIX
                    const vixEl = document.getElementById('vixValue');
                    if (state.vix !== undefined) {
                        const vixColor = state.vix > 25 ? 'text-rose-400' : state.vix > 20 ? 'text-amber-400' : 'text-emerald-400';
                        vixEl.className = `font-mono ${vixColor}`;
                        vixEl.textContent = state.vix.toFixed(2);
                    }

                    // Update Market Regime
                    const regimeEl = document.getElementById('marketRegime');
                    const colorMap = {
                        emerald: 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20',
                        amber: 'bg-amber-500/10 text-amber-400 border-amber-500/20',
                        rose: 'bg-rose-500/10 text-rose-400 border-rose-500/20'
                    };
                    regimeEl.className = `px-2 py-1 rounded font-medium border ${colorMap[state.regimeColor] || colorMap.amber}`;
                    regimeEl.textContent = state.marketRegime || 'Unknown';

                    // Update GEX
                    const gexEl = document.getElementById('gexValue');
                    if (state.gex !== undefined) {
                        const gexVal = state.gex;
                        const gexColor = gexVal > 1 ? 'text-emerald-400' : gexVal < -1 ? 'text-rose-400' : 'text-slate-400';
                        gexEl.className = `font-mono ${gexColor}`;
                        gexEl.textContent = '$' + gexVal.toFixed(2) + 'B';
                    }
                }
            } catch (error) {
                console.error('Error fetching market header:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchMarketHeader();
            // Refresh market header every 5 minutes
            setInterval(fetchMarketHeader, 300000);
        });
    </script>
</body>

</html>