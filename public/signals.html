<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trading Signals | Multi-Timeframe Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-dot {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .pulse-dot {
            animation: pulse-dot 2s ease-in-out infinite;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        .signal-STRONG_BUY {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .signal-BUY {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .signal-WATCH {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .signal-HOLD {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .timeframe-pill {
            @apply inline-block px-2 py-1 rounded text-xs font-medium;
        }

        .tf-high {
            @apply bg-green-900/40 text-green-300 border border-green-800;
        }

        .tf-medium {
            @apply bg-blue-900/40 text-blue-300 border border-blue-800;
        }

        .tf-low {
            @apply bg-gray-800 text-gray-400 border border-gray-700;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>

<body class="bg-gray-950 text-gray-100">
    <!-- Navigation Tabs -->
    <nav class="bg-gray-900 border-b border-gray-800 sticky top-0 z-50 shadow-sm">
        <div class="container mx-auto px-4">
            <div class="flex gap-1">
                <a href="/index.html"
                    class="px-6 py-4 text-sm font-semibold text-gray-400 hover:text-white hover:bg-gray-800 transition">
                    üìä Main Dashboard
                </a>
                <a href="/signals.html"
                    class="px-6 py-4 text-sm font-semibold bg-gray-800 border-b-2 border-blue-500 text-white">
                    üéØ Live Signals
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="bg-gray-900 rounded-lg shadow-lg border border-gray-800 p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-white flex items-center gap-3">
                        üéØ Live Trading Signals
                        <span id="statusIndicator"
                            class="text-sm font-normal px-3 py-1 rounded-full bg-gray-800 text-gray-400">
                            Scanner: Stopped
                        </span>
                    </h1>
                    <p class="text-gray-400 mt-1">Multi-Timeframe Analysis | Auto-Refresh: <span
                            id="refreshTimer">30s</span></p>
                </div>
                <div class="flex gap-3">
                    <div class="flex gap-3">
                        <button id="startBtn"
                            class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow transition">
                            ‚ñ∂ Start Scanner
                        </button>
                        <button id="stopBtn"
                            class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg shadow transition">
                            ‚èπ Stop
                        </button>
                        <button id="refreshBtn"
                            class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow transition">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>
            </div>

            <!-- Scanner Status Details -->
            <div id="scannerDetails" class="mt-4 grid grid-cols-4 gap-4 pt-4 border-t border-gray-800 hidden">
                <div>
                    <p class="text-sm text-gray-500">Scan Interval</p>
                    <p class="text-lg font-semibold text-gray-200" id="scanInterval">-</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Watchlist Symbols</p>
                    <p class="text-lg font-semibold text-gray-200" id="watchlistCount">-</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Last Scan</p>
                    <p class="text-lg font-semibold text-gray-200" id="lastScan">-</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Next Scan In</p>
                    <p class="text-lg font-semibold text-gray-200" id="nextScan">-</p>
                </div>
            </div>

            <!-- Activity Console -->
            <div class="mt-4 pt-4 border-t border-gray-800">
                <button id="consoleToggleBtn"
                    class="flex items-center gap-2 text-sm font-semibold text-gray-300 hover:text-white mb-3">
                    <span id="consoleToggleIcon">‚ñº</span>
                    Activity Console
                    <span class="text-xs text-gray-500">(Live updates)</span>
                </button>

                <div id="activityConsole"
                    class="bg-gray-900 rounded-lg p-4 font-mono text-sm max-h-96 overflow-y-auto hidden">
                    <div id="consoleContent" class="space-y-1">
                        <div class="text-gray-400">Waiting for activity...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Signals Table -->
        <div class="bg-gray-900 rounded-lg shadow-lg border border-gray-800 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-800 text-gray-200">
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-semibold">Symbol</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold">Signal</th>
                            <th class="px-6 py-4 text-center text-sm font-semibold">Score</th>
                            <th class="px-6 py-4 text-right text-sm font-semibold">Entry</th>
                            <th class="px-6 py-4 text-right text-sm font-semibold">Stop</th>
                            <th class="px-6 py-4 text-right text-sm font-semibold">Target</th>
                            <th class="px-6 py-4 text-center text-sm font-semibold">Last Updated</th>
                            <th class="px-6 py-4 text-center text-sm font-semibold"></th>
                        </tr>
                    </thead>
                    <tbody id="signalsTable" class="divide-y divide-gray-800">
                        <tr>
                            <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                                <div class="flex flex-col items-center gap-3">
                                    <svg class="w-16 h-16 text-gray-700" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                                        </path>
                                    </svg>
                                    <p class="text-lg font-medium text-gray-400">No signals yet</p>
                                    <p class="text-sm text-gray-500">Start the scanner to begin analyzing your watchlist
                                    </p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Legend -->
        <div class="mt-6 bg-gray-900 rounded-lg shadow border border-gray-800 p-6">
            <h3 class="text-sm font-semibold text-gray-300 mb-3">Signal Legend</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full bg-green-500"></div>
                    <span class="text-sm text-gray-400">STRONG BUY (85%+, 3/3 timeframes bullish)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full bg-blue-500"></div>
                    <span class="text-sm text-gray-400">BUY (70%+, 2/3 timeframes bullish)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full bg-yellow-500"></div>
                    <span class="text-sm text-gray-400">WATCH (40%+, mixed signals)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full bg-gray-500"></div>
                    <span class="text-sm text-gray-400">HOLD (<40%, no clear direction)</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Expanded Details Modal -->
    <div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div
            class="bg-gray-900 border border-gray-800 rounded-lg shadow-2xl max-w-2xl w-full m-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold" id="modalSymbol">-</h2>
                    <button id="modalCloseBtn" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div id="modalContent" class="space-y-4">
                    <!-- Content populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let refreshInterval;
        let countdownInterval;
        let refreshCountdown = 30;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkScannerStatus();
            refreshSignals();
            startRefreshCountdown();
            fetchActivityLogs(); // Initial log fetch
            setInterval(fetchActivityLogs, 3000); // Update logs every 3 seconds

            // Event Listeners
            document.getElementById('startBtn').addEventListener('click', startScanner);
            document.getElementById('stopBtn').addEventListener('click', stopScanner);
            document.getElementById('refreshBtn').addEventListener('click', refreshSignals);
            document.getElementById('consoleToggleBtn').addEventListener('click', toggleConsole);
            document.getElementById('modalCloseBtn').addEventListener('click', closeModal);

            // Event delegation for table rows
            document.getElementById('signalsTable').addEventListener('click', (e) => {
                const row = e.target.closest('tr');
                if (row && row.dataset.symbol) {
                    showDetails(row.dataset.symbol);
                }
            });
        });

        // Toggle console visibility
        function toggleConsole() {
            const console = document.getElementById('activityConsole');
            const icon = document.getElementById('consoleToggleIcon');

            if (console.classList.contains('hidden')) {
                console.classList.remove('hidden');
                icon.textContent = '‚ñ≤';
            } else {
                console.classList.add('hidden');
                icon.textContent = '‚ñº';
            }
        }

        // Fetch activity logs
        async function fetchActivityLogs() {
            try {
                const response = await fetch('/api/auto/logs?limit=50');
                const data = await response.json();

                const consoleContent = document.getElementById('consoleContent');

                if (!data.logs || data.logs.length === 0) {
                    consoleContent.innerHTML = '<div class="text-gray-400">No activity yet...</div>';
                    return;
                }

                consoleContent.innerHTML = data.logs.map(log => {
                    const time = new Date(log.timestamp).toLocaleTimeString();
                    let colorClass = 'text-gray-300';
                    let icon = '‚Ä¢';

                    switch (log.type) {
                        case 'success':
                            colorClass = 'text-green-400';
                            icon = '‚úì';
                            break;
                        case 'warning':
                            colorClass = 'text-yellow-400';
                            icon = '‚ö†';
                            break;
                        case 'error':
                            colorClass = 'text-red-400';
                            icon = '‚úó';
                            break;
                        case 'info':
                        default:
                            colorClass = 'text-blue-400';
                            icon = '‚Ñπ';
                    }

                    return `
                        <div class="${colorClass} flex gap-2">
                            <span class="text-gray-500">[${time}]</span>
                            <span>${icon}</span>
                            <span>${escapeHtml(log.message)}</span>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error fetching logs:', error);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Start refresh countdown
        function startRefreshCountdown() {
            clearInterval(countdownInterval);
            refreshCountdown = 30;

            countdownInterval = setInterval(() => {
                refreshCountdown--;
                document.getElementById('refreshTimer').textContent = `${refreshCountdown}s`;

                if (refreshCountdown <= 0) {
                    refreshSignals();
                    refreshCountdown = 30;
                }
            }, 1000);
        }

        // Check scanner status
        async function checkScannerStatus() {
            try {
                const response = await fetch('/api/auto/status');
                const status = await response.json();

                const indicator = document.getElementById('statusIndicator');
                const details = document.getElementById('scannerDetails');

                if (status.isRunning) {
                    indicator.innerHTML = '<span class="pulse-dot">‚óè</span> Scanner: Running';
                    indicator.className = 'text-sm font-normal px-3 py-1 rounded-full bg-green-900/30 text-green-400 border border-green-900/50 flex items-center gap-2';
                    details.classList.remove('hidden');

                    document.getElementById('scanInterval').textContent = `${status.intervalMinutes} min`;
                    document.getElementById('watchlistCount').textContent = status.watchlistCount || 0;
                    document.getElementById('lastScan').textContent = status.lastScanTime ?
                        new Date(status.lastScanTime).toLocaleTimeString() : 'Never';

                    // Calculate next scan
                    if (status.lastScanTime) {
                        const nextScanTime = new Date(new Date(status.lastScanTime).getTime() + status.intervalMinutes * 60000);
                        const now = new Date();
                        const minutesUntil = Math.max(0, Math.round((nextScanTime - now) / 60000));
                        document.getElementById('nextScan').textContent = `${minutesUntil} min`;
                    }
                } else {
                    indicator.textContent = 'Scanner: Stopped';
                    indicator.className = 'text-sm font-normal px-3 py-1 rounded-full bg-gray-800 text-gray-400 border border-gray-700';
                    details.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error checking status:', error);
            }
        }

        // Refresh signals
        async function refreshSignals() {
            try {
                const response = await fetch('/api/signals/live');
                const signals = await response.json();

                const tbody = document.getElementById('signalsTable');

                if (!signals || signals.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                                <div class="flex flex-col items-center gap-3">
                                    <svg class="w-16 h-16 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <p class="text-lg font-medium text-gray-400">No signals yet</p>
                                    <p class="text-sm text-gray-500">Start the scanner to begin analyzing your watchlist</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = signals.map(signal => {
                    const signalClass = `signal-${signal.final_signal.replace(' ', '_')}`;
                    const timeAgo = getTimeAgo(signal.last_updated);

                    return `
                        <tr class="hover:bg-gray-800 slide-in cursor-pointer border-b border-gray-800 last:border-0" data-symbol="${signal.symbol}">
                            <td class="px-6 py-4">
                                <div class="font-bold text-lg text-gray-100">${signal.symbol}</div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="${signalClass} text-white px-4 py-2 rounded-lg font-semibold shadow-sm">
                                    ${signal.final_signal}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <div class="text-2xl font-bold text-gray-100">${signal.final_score}%</div>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <div class="text-lg font-semibold text-gray-300">
                                    ${signal.entry_price ? '$' + signal.entry_price.toFixed(2) : '-'}
                                </div>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <div class="text-lg text-red-400 font-medium">
                                    ${signal.stop_loss ? '$' + signal.stop_loss.toFixed(2) : '-'}
                                </div>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <div class="text-lg text-green-400 font-medium">
                                    ${signal.target_price ? '$' + signal.target_price.toFixed(2) : '-'}
                                </div>
                            </td>
                            <td class="px-6 py-4 text-center text-sm text-gray-500">
                                ${timeAgo}
                            </td>
                            <td class="px-6 py-4 text-center">
                                <button class="text-blue-400 hover:text-blue-300 font-medium text-sm">
                                    Details ‚Üí
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                checkScannerStatus();

            } catch (error) {
                console.error('Error refreshing signals:', error);
            }
        }

        // Show signal details
        async function showDetails(symbol) {
            try {
                const response = await fetch(`/api/signals/live/${symbol}`);
                const signal = await response.json();

                document.getElementById('modalSymbol').textContent = `${symbol} - Detailed Breakdown`;
                document.getElementById('modalContent').innerHTML = `
                    <div class="bg-gradient-to-r from-gray-800 to-gray-900 p-4 rounded-lg border border-gray-700">
                        <div class="text-3xl font-bold text-center mb-2 text-white">${signal.final_signal}</div>
                        <div class="text-5xl font-bold text-center text-blue-400">${signal.final_score}%</div>
                        <p class="text-center text-gray-400 mt-2">Aggregated Confidence Score</p>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-blue-900/20 border border-blue-900/30 p-4 rounded-lg text-center">
                            <p class="text-sm text-gray-400 mb-1">Entry Price</p>
                            <p class="text-2xl font-bold text-blue-400">
                                ${signal.entry_price ? '$' + signal.entry_price.toFixed(2) : 'N/A'}
                            </p>
                        </div>
                        <div class="bg-red-900/20 border border-red-900/30 p-4 rounded-lg text-center">
                            <p class="text-sm text-gray-400 mb-1">Stop Loss</p>
                            <p class="text-2xl font-bold text-red-400">
                                ${signal.stop_loss ? '$' + signal.stop_loss.toFixed(2) : 'N/A'}
                            </p>
                        </div>
                        <div class="bg-green-900/20 border border-green-900/30 p-4 rounded-lg text-center">
                            <p class="text-sm text-gray-400 mb-1">Target</p>
                            <p class="text-2xl font-bold text-green-400">
                                ${signal.target_price ? '$' + signal.target_price.toFixed(2) : 'N/A'}
                            </p>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-semibold text-gray-300 mb-3">Timeframe Breakdown</h3>
                        
                        <div class="space-y-3">
                            <div class="border-l-4 ${getScoreColor(signal.score_15m)} bg-gray-800 p-4 rounded border-r border-t border-b border-gray-700">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-semibold text-gray-200">15-Minute</span>
                                    <span class="timeframe-pill ${getScorePill(signal.score_15m)}">${signal.score_15m}%</span>
                                </div>
                                <div class="text-sm text-gray-400">
                                    <strong class="text-gray-200">${signal.signal_15m}</strong> - ${signal.top_strategy_15m}
                                </div>
                            </div>
                            
                            <div class="border-l-4 ${getScoreColor(signal.score_1h)} bg-gray-800 p-4 rounded border-r border-t border-b border-gray-700">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-semibold text-gray-200">1-Hour</span>
                                    <span class="timeframe-pill ${getScorePill(signal.score_1h)}">${signal.score_1h}%</span>
                                </div>
                                <div class="text-sm text-gray-400">
                                    <strong class="text-gray-200">${signal.signal_1h}</strong> - ${signal.top_strategy_1h}
                                </div>
                            </div>
                            
                            <div class="border-l-4 ${getScoreColor(signal.score_1d)} bg-gray-800 p-4 rounded border-r border-t border-b border-gray-700">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-semibold text-gray-200">Daily</span>
                                    <span class="timeframe-pill ${getScorePill(signal.score_1d)}">${signal.score_1d}%</span>
                                </div>
                                <div class="text-sm text-gray-400">
                                    <strong class="text-gray-200">${signal.signal_1d}</strong> - ${signal.top_strategy_1d}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-sm text-gray-500 text-center pt-4 border-t border-gray-700">
                        Last scanned: ${new Date(signal.scan_timestamp).toLocaleString()}
                    </div>
                `;

                document.getElementById('detailsModal').classList.remove('hidden');
                document.getElementById('detailsModal').classList.add('flex');

            } catch (error) {
                console.error('Error loading details:', error);
            }
        }

        function closeModal() {
            document.getElementById('detailsModal').classList.add('hidden');
            document.getElementById('detailsModal').classList.remove('flex');
        }

        // Helper functions
        function getTimeAgo(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const seconds = Math.floor((now - then) / 1000);

            if (seconds < 60) return 'Just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            return `${Math.floor(hours / 24)}d ago`;
        }

        function getScoreColor(score) {
            if (score >= 70) return 'border-green-500';
            if (score >= 40) return 'border-yellow-500';
            return 'border-gray-600';
        }

        function getScorePill(score) {
            if (score >= 70) return 'tf-high';
            if (score >= 40) return 'tf-medium';
            return 'tf-low';
        }

        // Scanner control functions
        async function startScanner() {
            try {
                const response = await fetch('/api/auto/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ intervalMinutes: 15 })
                });
                const result = await response.json();
                alert(result.message);
                checkScannerStatus();
                setTimeout(refreshSignals, 2000); // Refresh after 2s to see first results
            } catch (error) {
                console.error('Error starting scanner:', error);
                alert('Failed to start scanner');
            }
        }

        async function stopScanner() {
            try {
                const response = await fetch('/api/auto/stop', { method: 'POST' });
                const result = await response.json();
                alert(result.message);
                checkScannerStatus();
            } catch (error) {
                console.error('Error stopping scanner:', error);
                alert('Failed to stop scanner');
            }
        }

        // Close modal on outside click
        document.getElementById('detailsModal').addEventListener('click', (e) => {
            if (e.target.id === 'detailsModal') closeModal();
        });
    </script>
</body>

</html>